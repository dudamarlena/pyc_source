# uncompyle6 version 3.7.4
# Python bytecode 2.7 (62211)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: build/bdist.linux-x86_64/egg/insights/parsers/tests/test_haproxy_cfg.py
# Compiled at: 2019-05-16 13:41:33
from insights.core.context import OSP
from insights.parsers.haproxy_cfg import HaproxyCfg
from insights.tests import context_wrap
haproxy_osp = '\n# This file managed by Puppet\nglobal\n  daemon\n  group  haproxy\n  maxconn  10000\n  pidfile  /var/run/haproxy.pid\n  user  haproxy\n\ndefaults\n  log  127.0.0.1 local2 warning\n  mode  tcp\n  option  tcplog\n  option  redispatch\n  retries  3\n  timeout  connect 5s\n  timeout  client 30s\n  timeout  server 30s\n\nlisten amqp\n  bind 10.64.111.121:5672\n  mode  tcp\n  option  tcpka\n  option  tcplog\n  timeout  client 900m\n  timeout  server 900m\n  server lb-backend-ncerdlabdell397 10.64.111.11:5672  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:5672  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:5672  check inter 1s\n\nlisten ceilometer-api\n  bind 10.64.111.94:8777\n  bind 10.64.111.93:8777\n  bind 10.64.111.92:8777\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8777  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:8777  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:8777  check inter 1s\n\nlisten cinder-api\n  bind 10.64.111.97:8776\n  bind 10.64.111.96:8776\n  bind 10.64.111.95:8776\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8776  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:8776  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:8776  check inter 1s\n\nlisten galera\n  bind 10.64.111.98:3306\n  mode  tcp\n  option  tcplog\n  option  httpchk\n  option  tcpka\n  stick  on dst\n  stick-table  type ip size 2\n  timeout  client 90m\n  timeout  server 90m\n  server pcmk-ncerdlabdell397 10.64.111.11:3306  check inter 1s port 9200 on-marked-down shutdown-sessions\n  server pcmk-ncerdlabdell400 10.64.111.12:3306  check inter 1s port 9200 on-marked-down shutdown-sessions\n  server pcmk-ncerdlabdell401 10.64.111.13:3306  check inter 1s port 9200 on-marked-down shutdown-sessions\n\nlisten glance-api\n  bind 10.64.111.101:9292\n  bind 10.64.111.100:9292\n  bind 10.64.111.99:9292\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:9292  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:9292  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:9292  check inter 1s\n\nlisten glance-registry\n  bind 10.64.111.101:9191\n  bind 10.64.111.100:9191\n  bind 10.64.111.99:9191\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:9191  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:9191  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:9191  check inter 1s\n\nlisten heat-api\n  bind 10.64.111.104:8004\n  bind 10.64.111.103:8004\n  bind 10.64.111.102:8004\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8004  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:8004  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:8004  check inter 1s\n\nlisten heat-cfn\n  bind 10.64.111.107:8000\n  bind 10.64.111.106:8000\n  bind 10.64.111.105:8000\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8000  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:8000  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:8000  check inter 1s\n\nlisten heat-cloudwatch\n  bind 10.64.111.103:8003\n  bind 10.64.111.102:8003\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8003  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:8003  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:8003  check inter 1s\n\nlisten horizon\n  bind 10.64.111.110:80\n  bind 10.64.111.109:80\n  bind 10.64.111.108:80\n  mode  http\n  cookie  SERVERID insert indirect nocache\n  option  httplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:80 cookie lb-backend-ncerdlabdell397 check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:80 cookie lb-backend-ncerdlabdell400 check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:80 cookie lb-backend-ncerdlabdell401 check inter 1s\n\nlisten keystone-admin\n  bind 10.64.111.113:35357\n  bind 10.64.111.112:35357\n  bind 10.64.111.111:35357\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:35357  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:35357  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:35357  check inter 1s\n\nlisten keystone-public\n  bind 10.64.111.113:5000\n  bind 10.64.111.112:5000\n  bind 10.64.111.111:5000\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:5000  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:5000  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:5000  check inter 1s\n\nlisten neutron-api\n  bind 10.64.111.117:9696\n  bind 10.64.111.116:9696\n  bind 10.64.111.115:9696\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:9696  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:9696  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:9696  check inter 1s\n\nlisten nova-api\n  bind 10.64.111.120:8774\n  bind 10.64.111.119:8774\n  bind 10.64.111.118:8774\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8774  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:8774  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:8774  check inter 1s\n\nlisten nova-metadata\n  bind 10.64.111.120:8775\n  bind 10.64.111.119:8775\n  bind 10.64.111.118:8775\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:8775  check\n  server lb-backend-ncerdlabdell400 10.64.111.12:8775  check\n  server lb-backend-ncerdlabdell401 10.64.111.13:8775  check\n\nlisten nova-novncproxy\n  bind 10.64.111.120:6080\n  bind 10.64.111.119:6080\n  bind 10.64.111.118:6080\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:6080  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:6080  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:6080  check inter 1s\n\nlisten nova-xvpvncproxy\n  bind 10.64.111.120:6081\n  bind 10.64.111.119:6081\n  bind 10.64.111.118:6081\n  mode  tcp\n  option  tcplog\n  server lb-backend-ncerdlabdell397 10.64.111.11:6081  check inter 1s\n  server lb-backend-ncerdlabdell400 10.64.111.12:6081  check inter 1s\n  server lb-backend-ncerdlabdell401 10.64.111.13:6081  check inter 1s\n\nlisten stats\n  bind *:81\n  mode  http\n  stats  enable\n'
haproxy_mysql = '\n\nglobal\n  daemon\n  group  haproxy\n  log  /dev/log local0\n  maxconn  20480\n  pidfile  /var/run/haproxy.pid\n  user  haproxy\n\ndefaults\n  log  global\n  maxconn  4096\n  mode  tcp\n  retries  3\n  timeout  http-request 10s\n  timeout  queue 1m\n  timeout  connect 10s\n  timeout  client 1m\n  timeout  server 1m\n  timeout  check 10s\n\n\nlisten mysql\n  bind 10.0.1.10:3306\n  option tcpka\n  option httpchk\n  stick on dst\n  stick-table type ip size 1000\n  timeout client 0\n  timeout server 0\n  server chicago-controller-0 10.0.1.14:3306 backup check fall 5 inter 2000 on-marked-down shutdown-sessions port 9200 rise 2\n  server chicago-controller-1 10.0.1.12:3306 backup check fall 5 inter 2000 on-marked-down shutdown-sessions port 9200 rise 2\n  server chicago-controller-2 10.0.1.15:3306 backup check fall 5 inter 2000 on-marked-down shutdown-sessions port 9200 rise 2\n\n'
osp_c = OSP()
osp_c.role = 'Controller'

def test_haproxy_cls_1():
    r = HaproxyCfg(context_wrap(haproxy_osp, osp=osp_c))
    assert r.data.get('global').get('maxconn') == '10000'
    assert r.data.get('listen galera').get('mode') == 'tcp'


def test_haproxy_cls_2():
    result = HaproxyCfg(context_wrap(haproxy_mysql, osp=osp_c))
    assert 'daemon' in result.data.get('global')
    assert 'maxconn' in result.data.get('global')
    assert result.data.get('defaults').get('maxconn') == '4096'
    assert 'queue 1m' in result.data.get('defaults').get('timeout')