# uncompyle6 version 3.7.4
# Python bytecode 2.7 (62211)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: build/bdist.linux-x86_64/egg/insights/parsers/tests/test_pcs_status.py
# Compiled at: 2019-05-16 13:41:33
from insights.parsers.pcs_status import PCSStatus
from insights.tests import context_wrap
CLUSTER_NORMAL = ('\nCluster name: openstack\nLast updated: Fri Oct 14 15:45:32 2016\nLast change: Thu Oct 13 20:02:27 2016\nStack: corosync\nCurrent DC: myhost15 (1) - partition with quorum\nVersion: 1.1.12-a14efad\n3 Nodes configured\n143 Resources configured\n\n\nOnline: [ myhost15 myhost16 myhost17 ]\n\nFull list of resources:\n\n stonith-ipmilan-10.24.221.172\t(stonith:fence_ipmilan):\tStarted myhost15\n stonith-ipmilan-10.24.221.171\t(stonith:fence_ipmilan):\tStarted myhost16\n stonith-ipmilan-10.24.221.173\t(stonith:fence_ipmilan):\tStarted myhost15\n ip-ceilometer-pub-10.50.218.121\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-neutron-pub-10.50.218.129\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-ceilometer-prv-10.24.82.127\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-ceilometer-adm-10.24.82.126\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-horizon-pub-10.50.218.126\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-horizon-adm-10.24.82.137\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-amqp-pub-10.24.82.145\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-loadbalancer-pub-10.50.218.128\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-neutron-adm-10.24.82.141\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-neutron-prv-10.24.82.142\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-horizon-prv-10.24.82.138\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n Clone Set: memcached-clone [memcached]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: haproxy-clone [haproxy]\n     Started: [ myhost15 myhost16 myhost17 ]\n ip-galera-pub-10.24.82.130\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n Master/Slave Set: galera-master [galera]\n     Masters: [ myhost15 myhost16 myhost17 ]\n Clone Set: rabbitmq-server-clone [rabbitmq-server]\n     Started: [ myhost15 myhost16 myhost17 ]\n ip-keystone-pub-10.50.218.127\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-keystone-adm-10.24.82.139\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-keystone-prv-10.24.82.140\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n Clone Set: keystone-clone [keystone]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: fs-varlibglanceimages-clone [fs-varlibglanceimages]\n     Started: [ myhost15 myhost16 myhost17 ]\n ip-glance-pub-10.50.218.123\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-glance-prv-10.24.82.132\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-glance-adm-10.24.82.131\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n Clone Set: glance-registry-clone [glance-registry]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: glance-api-clone [glance-api]\n     Started: [ myhost15 myhost16 myhost17 ]\n ip-nova-pub-10.50.218.130\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-nova-adm-10.24.82.143\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-nova-prv-10.24.82.144\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n Clone Set: openstack-nova-novncproxy-clone [openstack-nova-novncproxy]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-nova-consoleauth-clone [openstack-nova-consoleauth]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-nova-conductor-clone [openstack-nova-conductor]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-nova-api-clone [openstack-nova-api]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-nova-scheduler-clone [openstack-nova-scheduler]\n     Started: [ myhost15 myhost16 myhost17 ]\n ip-cinder-pub-10.50.218.122\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-cinder-prv-10.24.82.129\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-cinder-adm-10.24.82.128\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n Clone Set: cinder-api-clone [cinder-api]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: cinder-scheduler-clone [cinder-scheduler]\n     Started: [ myhost15 myhost16 myhost17 ]\n cinder-volume\t(systemd:openstack-cinder-volume):\tStarted myhost15\n ip-heat-pub-10.50.218.124\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-heat-prv-10.24.82.134\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-heat-adm-10.24.82.133\t(ocf::heartbeat:IPaddr2):\tStarted myhost15\n ip-heat_cfn-pub-10.50.218.125\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-heat_cfn-prv-10.24.82.136\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n ip-heat_cfn-adm-10.24.82.135\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n Clone Set: neutron-server-clone [neutron-server]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: neutron-scale-clone [neutron-scale] (unique)\n     neutron-scale:0\t(ocf::neutron:NeutronScale):\tStarted myhost17\n     neutron-scale:1\t(ocf::neutron:NeutronScale):\tStarted myhost16\n     neutron-scale:2\t(ocf::neutron:NeutronScale):\tStarted myhost15\n Clone Set: neutron-ovs-cleanup-clone [neutron-ovs-cleanup]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: neutron-netns-cleanup-clone [neutron-netns-cleanup]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: neutron-openvswitch-agent-clone [neutron-openvswitch-agent]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: neutron-dhcp-agent-clone [neutron-dhcp-agent]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: neutron-l3-agent-clone [neutron-l3-agent]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: neutron-metadata-agent-clone [neutron-metadata-agent]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: heat-api-clone [heat-api]\n     Started: [ myhost15 myhost16 myhost17 ]\n Resource Group: heat\n     openstack-heat-engine\t(systemd:openstack-heat-engine):\tStarted myhost15\n Clone Set: heat-api-cfn-clone [heat-api-cfn]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: heat-api-cloudwatch-clone [heat-api-cloudwatch]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: horizon-clone [horizon]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: mongod-clone [mongod]\n     Started: [ myhost15 myhost16 myhost17 ]\n openstack-ceilometer-central\t(systemd:openstack-ceilometer-central):\tStarted myhost16\n Clone Set: openstack-ceilometer-api-clone [openstack-ceilometer-api]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-ceilometer-alarm-evaluator-clone [openstack-ceilometer-alarm-evaluator]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-ceilometer-collector-clone [openstack-ceilometer-collector]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-ceilometer-notification-clone [openstack-ceilometer-notification]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: openstack-ceilometer-alarm-notifier-clone [openstack-ceilometer-alarm-notifier]\n     Started: [ myhost15 myhost16 myhost17 ]\n Clone Set: ceilometer-delay-clone [ceilometer-delay]\n     Started: [ myhost15 myhost16 myhost17 ]\n openstack-nova-compute-vc13cl42\t(systemd:openstack-nova-compute-vc13cl42):\tStarted myhost15\n openstack-manila-api\t(systemd:openstack-manila-api):\tStarted myhost16\n openstack-manila-scheduler\t(systemd:openstack-manila-scheduler):\tStarted myhost16\n openstack-manila-share\t(systemd:openstack-manila-share):\tStarted myhost16\n ip-manila-10.50.218.150\t(ocf::heartbeat:IPaddr2):\tStarted myhost16\n\nPCSD Status:\n  myhost15: Online\n  myhost17: Online\n  myhost16: Online\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n').strip()
CLUSTER_NODES_AND_RESOURCES = '\nCluster name: tripleo_cluster\nLast updated: Tue May  2 03:08:03 2017          Last change: Tue May  2 01:54:35 2017 by root via crm_resource on overcloud-controller-0\nStack: corosync\nCurrent DC: overcloud-controller-0 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n3 nodes and 112 resources configured\n\nOnline: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n\nFull list of resources:\n\n ip-172.20.20.10        (ocf::heartbeat:IPaddr2):       Started overcloud-controller-0\n Clone Set: haproxy-clone [haproxy]\n     Started: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n ip-10.67.16.160        (ocf::heartbeat:IPaddr2):       Started overcloud-controller-2\n ip-172.40.40.10        (ocf::heartbeat:IPaddr2):       Started overcloud-controller-0\n ip-172.50.50.10        (ocf::heartbeat:IPaddr2):       Started overcloud-controller-1\n ip-192.0.2.31  (ocf::heartbeat:IPaddr2):       Started overcloud-controller-0\n ip-172.20.20.11        (ocf::heartbeat:IPaddr2):       Started overcloud-controller-2\n Master/Slave Set: redis-master [redis]\n     Masters: [ overcloud-controller-0 ]\n     Slaves: [ overcloud-controller-1 overcloud-controller-2 ]\n Master/Slave Set: galera-master [galera]\n     Masters: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n Clone Set: mongod-clone [mongod]\n     Started: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n Clone Set: rabbitmq-clone [rabbitmq]\n     Started: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n Clone Set: memcached-clone [memcached]\n     Started: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n Clone Set: openstack-nova-scheduler-clone [openstack-nova-scheduler]\n     Started: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n Clone Set: neutron-l3-agent-clone [neutron-l3-agent]\n     Started: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]\n\nPCSD Status:\n  overcloud-controller-0: Online\n  overcloud-controller-1: Online\n  overcloud-controller-2: Online\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n'
CLUSTER_NOT_RUNNING = '\nError: cluster is not currently running on this node\n'
CLUSTER_WARNINGS = "\nWARNING: We don't know where, but something awful is going to happen\nWARNING: This is another made-up warning, please supply real ones\n"
CLUSTER_UNCLEANNODE = '\nNode control-2: UNCLEAN (online)\nOnline: [ control-0 control-1 ]\nRemoteOnline: [ compute-0 compute-1 compute-2 compute-3 compute-4 compute-5 compute-6 compute-7 ]\n\nPCSD Status:\n  control-0: Online\n  control-1: Online\n  control-2: Online\n'

def test_pcs_status():
    pcs = PCSStatus(context_wrap(CLUSTER_NORMAL))
    assert pcs.nodes == ['myhost15', 'myhost17', 'myhost16']
    assert pcs.get('Stack') == 'corosync'
    assert pcs.get('Cluster name') == 'openstack'
    assert pcs.get('Current DC') == 'myhost15 (1) - partition with quorum'
    assert pcs.get('Nodes configured') == '3'
    assert pcs.get('Resources configured') == '143'
    assert pcs.get('Online') == '[ myhost15 myhost16 myhost17 ]'
    assert pcs.get('Nonexistent key') is None
    return


def test_pcs_nodes_and_resources():
    pcs = PCSStatus(context_wrap(CLUSTER_NODES_AND_RESOURCES))
    assert pcs.nodes == ['overcloud-controller-0', 'overcloud-controller-1', 'overcloud-controller-2']
    assert pcs.data['Nodes configured'] == '3'
    assert pcs.data['Resources configured'] == '112'
    assert pcs.data['Daemon Status'] == [
     'corosync: active/enabled',
     'pacemaker: active/enabled',
     'pcsd: active/enabled']


def test_cluster_not_running():
    pcs = PCSStatus(context_wrap(CLUSTER_NOT_RUNNING))
    assert pcs.nodes == []


def test_cluster_warning():
    pcs = PCSStatus(context_wrap(CLUSTER_WARNINGS))
    assert pcs.nodes == []
    assert pcs.data['WARNING'] == [
     "WARNING: We don't know where, but something awful is going to happen",
     'WARNING: This is another made-up warning, please supply real ones']


def test_pcs_uncleannode():
    pcs = PCSStatus(context_wrap(CLUSTER_UNCLEANNODE))
    assert pcs.nodes == ['control-0', 'control-1', 'control-2']
    assert pcs.bad_nodes == [{'status': 'UNCLEAN (online)', 'name': 'control-2'}]