# uncompyle6 version 3.7.4
# Python bytecode 2.7 (62211)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: build/bdist.linux-x86_64/egg/insights/parsers/tests/test_dnf_module.py
# Compiled at: 2019-11-14 13:57:46
import doctest, pytest
from insights.parsers import dnf_module, SkipException
from insights.parsers.dnf_module import DnfModuleList, DnfModuleInfo
from insights.tests import context_wrap
DNF_MODULE_LIST = ('\nUpdating Subscription Management repositories.\nRed Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs)                  1.9 kB/s | 4.5 kB     00:02\nRed Hat Enterprise Linux 8 for x86_64 - BaseOS (RPMs)                     1.7 kB/s | 4.0 kB     00:02\nRed Hat Enterprise Linux 8 for x86_64 - Supplementary (RPMs)              1.6 kB/s | 3.8 kB     00:02\nRed Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs)\nName                Stream      Profiles                                  Summary\n389-ds              1.4                                                   389 Directory Server (base)\nant                 1.10 [d]    common [d]                                Java build tool\ncontainer-tools     1.0         common [d]                                Common tools and dependencies for container runtimes\ncontainer-tools     rhel8 [d]   common [d]                                Common tools and dependencies for container runtimes\nfreeradius          3.0 [d]     server [d]                                High-performance and highly configurable free RADIUS server\ngimp                2.8 [d]     common [d], devel                         gimp module\ngo-toolset          rhel8 [d]   common [d]                                Go\nhttpd               2.4 [d][e]  common [d] [i], devel, minimal            Apache HTTP Server\nidm                 DL1         common [d], adtrust, client, dns, server  The Red Hat Enterprise Linux Identity Management system module\npki-core            10.6                                                  PKI Core\npki-deps            10.6                                                  PKI Dependencies module\npostgresql          10 [d]      client, server [d]                        PostgreSQL server and client module\npostgresql          9.6         client, server [d]                        PostgreSQL server and client module\npython27            2.7 [d]     common [d]                                Python programming language, version 2.7\npython36            3.6 [d][e]  common [d], build                         Python programming language, version 3.6\nredis               5 [d]       common [d]                                Redis persistent key-value database\nrhn-tools           1.0 [d]     common [d]                                Red Hat Satellite 5 tools for RHEL\nruby                2.5 [d]     common [d]                                An interpreter of object-oriented scripting language\nrust-toolset        rhel8 [d]   common [d]                                Rust\nsatellite-5-client  1.0 [d]     common [d], gui                           Red Hat Satellite 5 client packages\nscala               2.10 [d]    common [d]                                A hybrid functional/object-oriented language for the JVM\nsquid               4 [d]       common [d]                                Squid - Optimising Web Delivery\nsubversion          1.10 [d]    common [d], server                        Apache Subversion\nswig                3.0 [d]     common [d], complete                      Connects C/C++/Objective C to some high-level programming languages\nvarnish             6 [d]       common [d]                                Varnish HTTP cache\nvirt                rhel [d]    common [d]                                Virtualization module\n\nHint: [d]efault, [e]nabled, [x]disabled, [i]nstalled\n').strip()
DNF_MODULE_LIST_DOC = ('\nUpdating Subscription Management repositories.\nName                Stream      Profiles                                  Summary\n389-ds              1.4                                                   389 Directory Server (base)\nant                 1.10 [d]    common [d]                                Java build tool\n\nHint: [d]efault, [e]nabled, [x]disabled, [i]nstalled\n').strip()
DNF_MODULE_LIST_EXP1 = ("\nUpdating Subscription Management repositories.\nCache-only enabled but no cache for 'rhel-8-for-x86_64-appstream-rpms', ignoring this repo.\nCache-only enabled but no cache for 'rhel-8-for-x86_64-baseos-rpms', ignoring this repo.\nCache-only enabled but no cache for 'rhel-8-for-x86_64-supplementary-rpms', ignoring this repo.\nNo matching Modules to list\n").strip()
DNF_MODULE_LIST_EXP2 = ('\nUpdating Subscription Management repositories.\nName                Stream      Profiles                                  Summary\nError: xxx\n').strip()
DNF_MODULE_INFO = ('\nUpdating Subscription Management repositories.\nLast metadata expiration check: 0:02:09 ago on Thu 25 Jul 2019 01:32:41 PM CST.\nName             : httpd\nStream           : 2.4 [d][e][a]\nVersion          : 8000020190405071959\nContext          : 55190bc5\nProfiles         : common [d] [i], devel, minimal\nDefault profiles : common\nRepo             : rhel-8-for-x86_64-appstream-rpms\nSummary          : Apache HTTP Server\nDescription      : Apache httpd is a powerful, efficient, and extensible HTTP server.\nArtifacts        : httpd-0:2.4.37-11.module+el8.0.0+2969+90015743.src\n                 : httpd-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : httpd-debuginfo-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : httpd-debugsource-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : httpd-devel-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : httpd-filesystem-0:2.4.37-11.module+el8.0.0+2969+90015743.noarch\n                 : httpd-manual-0:2.4.37-11.module+el8.0.0+2969+90015743.noarch\n                 : httpd-tools-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : httpd-tools-debuginfo-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_http2-0:1.11.3-2.module+el8.0.0+2969+90015743.src\n                 : mod_http2-0:1.11.3-2.module+el8.0.0+2969+90015743.x86_64\n                 : mod_http2-debuginfo-0:1.11.3-2.module+el8.0.0+2969+90015743.x86_64\n                 : mod_http2-debugsource-0:1.11.3-2.module+el8.0.0+2969+90015743.x86_64\n                 : mod_ldap-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_ldap-debuginfo-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_md-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_md-debuginfo-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_proxy_html-1:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_proxy_html-debuginfo-1:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_session-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_session-debuginfo-0:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_ssl-1:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n                 : mod_ssl-debuginfo-1:2.4.37-11.module+el8.0.0+2969+90015743.x86_64\n\nName             : httpd\nStream           : 2.4 [d][e][a]\nVersion          : 820190206142837\nContext          : 9edba152\nProfiles         : common [d] [i], devel, minimal\nDefault profiles : common\nRepo             : rhel-8-for-x86_64-appstream-rpms\nSummary          : Apache HTTP Server\nDescription      : Apache httpd is a powerful, efficient, and extensible HTTP server.\nArtifacts        : httpd-0:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : httpd-devel-0:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : httpd-filesystem-0:2.4.37-10.module+el8+2764+7127e69e.noarch\n                 : httpd-manual-0:2.4.37-10.module+el8+2764+7127e69e.noarch\n                 : httpd-tools-0:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : mod_http2-0:1.11.3-1.module+el8+2443+605475b7.x86_64\n                 : mod_ldap-0:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : mod_md-0:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : mod_proxy_html-1:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : mod_session-0:2.4.37-10.module+el8+2764+7127e69e.x86_64\n                 : mod_ssl-1:2.4.37-10.module+el8+2764+7127e69e.x86_64\n\nName             : ant\nStream           : 1.10 [d][a]\nVersion          : 820181213135032\nContext          : 5ea3b708\nProfiles         : common [d]\nDefault profiles : common\nRepo             : rhel-8-for-x86_64-appstream-rpms\nSummary          : Java build tool\nDescription      : Apache Ant is a Java library and command-line tool whose mission is to drive processes described in build files as targets and extension points dependent upon each other. The main known usage of Ant is the build of Java applications. Ant supplies a number of built-in tasks allowing to compile, assemble, test and run Java applications. Ant can also be used effectively to build non Java applications, for instance C or C++ applications. More generally, Ant can be used to pilot any type of process which can be described in terms of targets and tasks.\nArtifacts        : ant-0:1.10.5-1.module+el8+2438+c99a8a1e.noarch\n                 : ant-lib-0:1.10.5-1.module+el8+2438+c99a8a1e.noarch\n\nName        : 389-ds\nStream      : 1.4\nVersion     : 8000020190424152135\nContext     : ab753183\nRepo        : rhel-8-for-x86_64-appstream-rpms\nSummary     : 389 Directory Server (base)\nDescription : 389 Directory Server is an LDAPv3 compliant server.  The base package includes the LDAP server and command line utilities for server administration.\nArtifacts   : 389-ds-base-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.src\n            : 389-ds-base-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-debuginfo-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-debugsource-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-devel-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-legacy-tools-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-legacy-tools-debuginfo-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-libs-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-libs-debuginfo-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-snmp-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : 389-ds-base-snmp-debuginfo-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.x86_64\n            : python3-lib389-0:1.4.0.20-10.module+el8.0.0+3096+101825d5.noarch\n\nName        : 389-ds\nStream      : 1.4\nVersion     : 820190201170147\nContext     : 1fc8b219\nRepo        : rhel-8-for-x86_64-appstream-rpms\nSummary     : 389 Directory Server (base)\nDescription : 389 Directory Server is an LDAPv3 compliant server.  The base package includes the LDAP server and command line utilities for server administration.\nArtifacts   : 389-ds-base-0:1.4.0.20-7.module+el8+2750+1f4079fb.x86_64\n            : 389-ds-base-devel-0:1.4.0.20-7.module+el8+2750+1f4079fb.x86_64\n            : 389-ds-base-legacy-tools-0:1.4.0.20-7.module+el8+2750+1f4079fb.x86_64\n            : 389-ds-base-libs-0:1.4.0.20-7.module+el8+2750+1f4079fb.x86_64\n            : 389-ds-base-snmp-0:1.4.0.20-7.module+el8+2750+1f4079fb.x86_64\n            : python3-lib389-0:1.4.0.20-7.module+el8+2750+1f4079fb.noarch\n\nHint: [d]efault, [e]nabled, [x]disabled, [i]nstalled, [a]ctive]\n').strip()
DNF_MODULE_INFO_EXP = ('\nUpdating Subscription Management repositories.\nLast metadata expiration check: 0:03:24 ago on Thu 25 Jul 2019 01:32:41 PM CST.\nUnable to resolve argument abc\nError: No matching Modules to list\n').strip()

def test_dnf_module_list():
    module_list = DnfModuleList(context_wrap(DNF_MODULE_LIST))
    assert 'ant' in module_list
    assert module_list['httpd'].name == 'httpd'
    assert module_list['httpd'].stream == '2.4 [d][e]'


def test_dnf_module_list_exp():
    with pytest.raises(ValueError):
        DnfModuleList(context_wrap(DNF_MODULE_LIST_EXP1))
    with pytest.raises(SkipException):
        DnfModuleList(context_wrap(DNF_MODULE_LIST_EXP2))


def test_dnf_module_info():
    module_infos = DnfModuleInfo(context_wrap(DNF_MODULE_INFO))
    assert len(module_infos) == 3
    assert module_infos.modules == ['389-ds', 'ant', 'httpd']
    assert len(module_infos['httpd']) == 2
    assert module_infos['httpd'][0].name == 'httpd'
    assert module_infos['httpd'][0].version == '8000020190405071959'
    assert len(module_infos['httpd'][0].profiles) == 3
    assert module_infos['httpd'][0].default_profiles == 'common'
    assert module_infos['httpd'][1].summary == 'Apache HTTP Server'
    assert module_infos['httpd'][1].context == '9edba152'
    assert 'mod_http2-0:1.11.3-1.module+el8+2443+605475b7.x86_64' in module_infos['httpd'][1].artifacts


def test_dnf_module_info_exp():
    with pytest.raises(SkipException):
        DnfModuleInfo(context_wrap(DNF_MODULE_INFO_EXP))


def test_dnf_module_doc_examples():
    env = {'dnf_module_list': DnfModuleList(context_wrap(DNF_MODULE_LIST_DOC)), 
       'dnf_module_info': DnfModuleInfo(context_wrap(DNF_MODULE_INFO))}
    failed, total = doctest.testmod(dnf_module, globs=env)
    assert failed == 0