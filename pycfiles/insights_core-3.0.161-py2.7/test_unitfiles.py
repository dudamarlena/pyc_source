# uncompyle6 version 3.7.4
# Python bytecode 2.7 (62211)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: build/bdist.linux-x86_64/egg/insights/parsers/tests/test_unitfiles.py
# Compiled at: 2019-12-13 11:35:35
import doctest
from insights.tests import context_wrap
from insights.parsers.systemd import unitfiles
from insights.parsers.systemd.unitfiles import UnitFiles, ListUnits
KDUMP_DISABLED_RHEL7 = ('\nUNIT FILE                                   STATE\nkdump.service                               disabled\n').strip()
KDUMP_ENABLED_RHEL7 = ('\nUNIT FILE                                   STATE\nkdump.service                               enabled\n').strip()
KDUMP_ENABLED_FOOTER_RHEL7 = ('\nUNIT FILE                                   STATE\nkdump.service                               enabled\n1 unit file listed.\n').strip()
KDUMP_BIG_TEST = ('\nUNIT FILE                                   STATE\nkdump.service                               enabled\nother.service                               disabled\ntest.service                                static\n\n3 unit files listed.\n').strip()
UNIT_INVALID_VS_VALID = '\nUNIT FILE                                   STATE\nsvca.service                                enabled\nsvcb.service                                masked\nsvcc.service                                somenonsense\n\n3 unit files listed.\n'

def test_unitfiles():
    context = context_wrap(KDUMP_DISABLED_RHEL7)
    unitfiles = UnitFiles(context)
    assert not unitfiles.is_on('kdump.service')
    assert len(unitfiles.services) == 1
    assert len(unitfiles.parsed_lines) == 1
    context = context_wrap(KDUMP_ENABLED_RHEL7)
    unitfiles = UnitFiles(context)
    assert unitfiles.is_on('kdump.service')
    assert len(unitfiles.services) == 1
    assert len(unitfiles.parsed_lines) == 1
    context = context_wrap(KDUMP_ENABLED_RHEL7)
    unitfiles = UnitFiles(context)
    assert unitfiles.is_on('kdump.service')
    assert len(unitfiles.services) == 1
    assert len(unitfiles.parsed_lines) == 1
    context = context_wrap(KDUMP_BIG_TEST)
    unitfiles = UnitFiles(context)
    assert unitfiles.is_on('kdump.service')
    assert not unitfiles.is_on('other.service')
    assert unitfiles.is_on('test.service')
    assert len(unitfiles.services) == 3
    assert len(unitfiles.parsed_lines) == 3
    context = context_wrap(UNIT_INVALID_VS_VALID)
    unitfiles = UnitFiles(context)
    assert unitfiles.is_on('svca.service')
    assert 'svca.service' in unitfiles.services
    assert 'svca.service' in unitfiles.service_list
    assert 'svcb.service' in unitfiles.services
    assert 'svcb.service' in unitfiles.service_list
    assert 'svcc.service' not in unitfiles.services
    assert 'svcc.service' not in unitfiles.service_list
    assert True is unitfiles.is_on('svca.service')
    assert False is unitfiles.is_on('svcb.service')
    assert None is unitfiles.is_on('svcc.service')
    assert unitfiles.exists('svca.service')
    assert unitfiles.exists('svcb.service')
    assert not unitfiles.exists('svcc.service')
    return


LISTUNITS_CONTENT = ("\n  proc-sys-fs-binfmt_misc.automount                                           loaded active waiting   Arbitrary Executable File Formats File System Automount Point\n  sys-devices-pci0000:00-0000:00:03.0-virtio0-net-eth0.device                 loaded active plugged   Virtio network device\n  sys-devices-pci0000:00-0000:00:04.0-virtio1-net-eth1.device                 loaded active plugged   Virtio network device\n  sys-devices-pci0000:00-0000:00:05.0-virtio2-net-eth2.device                 loaded active plugged   Virtio network device\n  sys-devices-pci0000:00-0000:00:07.0-virtio3-virtio-ports-vport3p1.device loaded active plugged   /sys/devices/pci0000:00/0000:00:07.0/virtio3/virtio-ports/vport3p1\n  sys-devices-pci0000:00-0000:00:08.0-virtio4-block-vda-vda1.device           loaded active plugged   /sys/devices/pci0000:00/0000:00:08.0/virtio4/block/vda/vda1\n  sys-devices-pci0000:00-0000:00:08.0-virtio4-block-vda.device                loaded active plugged   /sys/devices/pci0000:00/0000:00:08.0/virtio4/block/vda\n  sys-devices-platform-serial8250-tty-ttyS1.device                            loaded active plugged   /sys/devices/platform/serial8250/tty/ttyS1\n  sys-devices-platform-serial8250-tty-ttyS2.device                            loaded active plugged   /sys/devices/platform/serial8250/tty/ttyS2\n  sys-devices-platform-serial8250-tty-ttyS3.device                            loaded active plugged   /sys/devices/platform/serial8250/tty/ttyS3\n  sys-devices-pnp0-00:04-tty-ttyS0.device                                     loaded active plugged   /sys/devices/pnp0/00:04/tty/ttyS0\n  sys-devices-virtual-block-dm-0.device                                    loaded active plugged   /sys/devices/virtual/block/dm-0\n  sys-devices-virtual-block-loop0.device                                      loaded active plugged   /sys/devices/virtual/block/loop0\n  sys-devices-virtual-block-loop1.device                                      loaded active plugged   /sys/devices/virtual/block/loop1\n  sys-devices-virtual-net-br-ctlplane.device                               loaded active plugged   /sys/devices/virtual/net/br-ctlplane\n  sys-devices-virtual-net-br-int.device                                    loaded active plugged   /sys/devices/virtual/net/br-int\n  sys-devices-virtual-net-docker0.device                                      loaded active plugged   /sys/devices/virtual/net/docker0\n  sys-devices-virtual-net-eth1.905.device                                     loaded active plugged   /sys/devices/virtual/net/eth1.905\n  sys-devices-virtual-net-ovs-system.device                                loaded active plugged   /sys/devices/virtual/net/ovs-system\n  sys-module-configfs.device                                                  loaded active plugged   /sys/module/configfs\n  sys-subsystem-net-devices-br-ctlplane.device                             loaded active plugged   /sys/subsystem/net/devices/br-ctlplane\n  sys-subsystem-net-devices-br-int.device                                  loaded active plugged   /sys/subsystem/net/devices/br-int\n  sys-subsystem-net-devices-docker0.device                                    loaded active plugged   /sys/subsystem/net/devices/docker0\n  sys-subsystem-net-devices-eth0.device                                       loaded active plugged   Virtio network device\n  sys-subsystem-net-devices-eth1.905.device                                   loaded active plugged   /sys/subsystem/net/devices/eth1.905\n  sys-subsystem-net-devices-eth1.device                                       loaded active plugged   Virtio network device\n  sys-subsystem-net-devices-eth2.device                                       loaded active plugged   Virtio network device\n  sys-subsystem-net-devices-ovs-system.device                              loaded active plugged   /sys/subsystem/net/devices/ovs-system\n  -.mount                                                                     loaded active mounted   /\n  dev-hugepages.mount                                                         loaded active mounted   Huge Pages File System\n  dev-mqueue.mount                                                            loaded active mounted   POSIX Message Queue File System\n  proc-fs-nfsd.mount                                                          loaded active mounted   NFSD configuration filesystem\n  run-netns.mount                                                             loaded active mounted   /run/netns\n  run-user-0.mount                                                            loaded active mounted   /run/user/0\n  sys-kernel-config.mount                                                     loaded active mounted   Configuration File System\n  sys-kernel-debug.mount                                                      loaded active mounted   Debug File System\n  var-lib-nfs-rpc_pipefs.mount                                                loaded active mounted   RPC Pipe File System\n  brandbot.path                                                               loaded active waiting   Flexible branding\n  systemd-ask-password-console.path                                           loaded active waiting   Dispatch Password Requests to Console Directory Watch\n  systemd-ask-password-wall.path                                              loaded active waiting   Forward Password Requests to Wall Directory Watch\n  session-97.scope                                                            loaded active running   Session 97 of user root\n  atd.service                                                                 loaded active running   Job spooling tools\n  auditd.service                                                              loaded active running   Security Auditing Service\n  bootif-fix.service                                                          loaded active running   Automated fix for incorrect iPXE BOOFIF\n  chronyd.service                                                             loaded active running   NTP client/server\n  crond.service                                                               loaded active running   Command Scheduler\n  dbus.service                                                                loaded active running   D-Bus System Message Bus\n  dnsmasq.service                                                             loaded active running   DNS caching server.\n  docker-distribution.service                                                 loaded active running   v2 Registry server for Docker\n‚óè docker-storage-setup.service                                                loaded failed failed    Docker Storage Setup\n  docker.service                                                              loaded active running   Docker Application Container Engine\n  epmd@0.0.0.0.service                                                        loaded active running   Erlang Port Mapper Daemon\n  getty@tty1.service                                                          loaded active running   Getty on tty1\n  gssproxy.service                                                            loaded active running   GSSAPI Proxy Daemon\n  httpd.service                                                               loaded active running   The Apache HTTP Server\n  iptables.service                                                            loaded active exited    IPv4 firewall with iptables\n  ipxe-timeout-fix.service                                                    loaded active running   Automated fix for incorrect iPXE timeout\n  ironicapi-fix.service                                                       loaded active running   Automated fix to restart ironic-api when it crashes\n  irqbalance.service                                                          loaded active running   irqbalance daemon\n  iscsi-shutdown.service                                                      loaded active exited    Logout off all iSCSI sessions on shutdown\n  iscsid.service                                                              loaded active running   Open-iSCSI\n  kdump.service                                                               loaded active exited    Crash recovery kernel arming\n  kmod-static-nodes.service                                                   loaded active exited    Create list of required static device nodes for the current kernel\n  ksm.service                                                                 loaded active exited    Kernel Samepage Merging\n  ksmtuned.service                                                            loaded active running   Kernel Samepage Merging (KSM) Tuning Daemon\n  libvirtd.service                                                            loaded active running   Virtualization daemon\n  lvm2-lvmetad.service                                                        loaded active running   LVM2 metadata daemon\n  lvm2-monitor.service                                                        loaded active exited    Monitoring of LVM2 mirrors, snapshots etc. using dmeventd or progress polling\n  mariadb.service                                                             loaded active running   MariaDB database server\n  memcached.service                                                           loaded active running   memcached daemon\n  mongod.service                                                              loaded active running   High-performance, schema-free document-oriented database\n  netcf-transaction.service                                                   loaded active exited    Rollback uncommitted netcf network config change transactions\n  network.service                                                             loaded active exited    LSB: Bring up/down networking\n‚óè NetworkManager-wait-online.service                                          loaded failed failed    Network Manager Wait Online\n  NetworkManager.service                                                      loaded active running   Network Manager\n  neutron-dhcp-agent.service                                                  loaded active running   OpenStack Neutron DHCP Agent\n  neutron-openvswitch-agent.service                                           loaded active running   OpenStack Neutron Open vSwitch Agent\n  neutron-ovs-cleanup.service                                                 loaded active exited    OpenStack Neutron Open vSwitch Cleanup Utility\n  neutron-server.service                                                      loaded active running   OpenStack Neutron Server\n  openstack-aodh-evaluator.service                                            loaded active running   OpenStack Alarm evaluator service\n  openstack-aodh-listener.service                                             loaded active running   OpenStack Alarm listener service\n  openstack-aodh-notifier.service                                             loaded active running   OpenStack Alarm notifier service\n  openstack-ceilometer-central.service                                        loaded active running   OpenStack ceilometer central agent\n  openstack-ceilometer-collector.service                                      loaded active running   OpenStack ceilometer collection service\n  openstack-ceilometer-notification.service                                   loaded active running   OpenStack ceilometer notification agent\n  openstack-glance-api.service                                                loaded active running   OpenStack Image Service (code-named Glance) API server\n  openstack-glance-registry.service                                           loaded active running   OpenStack Image Service (code-named Glance) Registry server\n  openstack-heat-api-cfn.service                                              loaded active running   Openstack Heat CFN-compatible API Service\n  openstack-heat-api.service                                                  loaded active running   OpenStack Heat API Service\n  openstack-heat-engine.service                                               loaded active running   Openstack Heat Engine Service\n  openstack-ironic-api.service                                                loaded active running   OpenStack Ironic API service\n  openstack-ironic-conductor.service                                          loaded active running   OpenStack Ironic Conductor service\n  openstack-ironic-inspector-dnsmasq.service                                  loaded active running   PXE boot dnsmasq service for Ironic Inspector\n  openstack-ironic-inspector.service                                          loaded active running   Hardware introspection service for OpenStack Ironic\n  openstack-mistral-api.service                                               loaded active running   Mistral API Server\n  openstack-mistral-engine.service                                            loaded active running   Mistral Engine Server\n  openstack-mistral-executor.service                                          loaded active running   Mistral Executor Server\n  openstack-nova-api.service                                                  loaded active running   OpenStack Nova API Server\n  openstack-nova-cert.service                                                 loaded active running   OpenStack Nova Cert Server\n  openstack-nova-compute.service                                              loaded active running   OpenStack Nova Compute Server\n  openstack-nova-conductor.service                                            loaded active running   OpenStack Nova Conductor Server\n  openstack-nova-scheduler.service                                            loaded active running   OpenStack Nova Scheduler Server\n  openstack-swift-account-reaper.service                                      loaded active running   OpenStack Object Storage (swift) - Account Reaper\n  openstack-swift-account.service                                             loaded active running   OpenStack Object Storage (swift) - Account Server\n  openstack-swift-container-updater.service                                   loaded active running   OpenStack Object Storage (swift) - Container Updater\n  openstack-swift-container.service                                           loaded active running   OpenStack Object Storage (swift) - Container Server\n  openstack-swift-object-updater.service                                      loaded active running   OpenStack Object Storage (swift) - Object Updater\n  openstack-swift-object.service                                              loaded active running   OpenStack Object Storage (swift) - Object Server\n  openstack-swift-proxy.service                                               loaded active running   OpenStack Object Storage (swift) - Proxy Server\n  openstack-zaqar.service                                                     loaded active running   OpenStack Message Queuing Service (code-named Zaqar) Server\n  openstack-zaqar@1.service                                                   loaded active running   OpenStack Message Queuing Service (code-named Zaqar) Server Instance 1\n  openvswitch.service                                                         loaded active exited    Open vSwitch\n‚óè ovirt-guest-agent.service                                                   loaded failed failed    oVirt Guest Agent\n  ovs-vswitchd.service                                                        loaded active running   Open vSwitch Forwarding Unit\n  ovsdb-server.service                                                        loaded active running   Open vSwitch Database Unit\n  polkit.service                                                              loaded active running   Authorization Manager\n  postfix.service                                                             loaded active running   Postfix Mail Transport Agent\n  qemu-guest-agent.service                                                    loaded active running   QEMU Guest Agent\n  rabbitmq-server.service                                                     loaded active running   RabbitMQ broker\n  rc-local.service                                                            loaded active exited    /etc/rc.d/rc.local Compatibility\n  rhel-dmesg.service                                                          loaded active exited    Dump dmesg to /var/log/dmesg\n  rhel-import-state.service                                                   loaded active exited    Import network configuration from initramfs\n  rhel-push-plugin.service                                                    loaded active running   Docker Block RHEL push plugin authZ Plugin\n  rhel-readonly.service                                                       loaded active exited    Configure read-only root support\n  rhnsd.service                                                               loaded active running   LSB: Starts the Spacewalk Daemon\n  rsyslog.service                                                             loaded active running   System Logging Service\n  serial-getty@ttyS0.service                                                  loaded active running   Serial Getty on ttyS0\n  sshd.service                                                                loaded active running   OpenSSH server daemon\n  systemd-journal-flush.service                                               loaded active exited    Flush Journal to Persistent Storage\n  systemd-journald.service                                                    loaded active running   Journal Service\n  systemd-logind.service                                                      loaded active running   Login Service\n  systemd-random-seed.service                                                 loaded active exited    Load/Save Random Seed\n  systemd-remount-fs.service                                                  loaded active exited    Remount Root and Kernel File Systems\n  systemd-sysctl.service                                                      loaded active exited    Apply Kernel Variables\n  systemd-tmpfiles-setup-dev.service                                          loaded active exited    Create Static Device Nodes in /dev\n  systemd-tmpfiles-setup.service                                              loaded active exited    Create Volatile Files and Directories\n  systemd-udev-trigger.service                                                loaded active exited    udev Coldplug all Devices\n  systemd-udevd.service                                                       loaded active running   udev Kernel Device Manager\n  systemd-update-utmp.service                                                 loaded active exited    Update UTMP about System Boot/Shutdown\n  systemd-user-sessions.service                                               loaded active exited    Permit User Sessions\n  systemd-vconsole-setup.service                                              loaded active exited    Setup Virtual Console\n  tuned.service                                                               loaded active running   Dynamic System Tuning Daemon\n  xinetd.service                                                              loaded active running   Xinetd A Powerful Replacement For Inetd\n  -.slice                                                                     loaded active active    Root Slice\n  system-epmd.slice                                                           loaded active active    system-epmd.slice\n  system-getty.slice                                                          loaded active active    system-getty.slice\n  system-openstack-zaqar.slice                                             loaded active active    system-openstack-zaqar.slice\n  system-selinux-policy-migrate-local-changes.slice               loaded active active    system-selinux-policy-migrate-local-changes.slice\n  system-serial-getty.slice                                                loaded active active    system-serial-getty.slice\n  system.slice                                                                loaded active active    System Slice\n  user-0.slice                                                                loaded active active    user-0.slice\n  user.slice                                                                  loaded active active    User and Session Slice\n  dbus.socket                                                                 loaded active running   D-Bus System Message Bus Socket\n  dm-event.socket                                                             loaded active listening Device-mapper event daemon FIFOs\n  epmd@0.0.0.0.socket                                                         loaded active running   Erlang Port Mapper Daemon Activation Socket\n  iscsid.socket                                                               loaded active running   Open-iSCSI iscsid Socket\n  iscsiuio.socket                                                             loaded active listening Open-iSCSI iscsiuio Socket\n  lvm2-lvmetad.socket                                                         loaded active running   LVM2 metadata daemon socket\n  lvm2-lvmpolld.socket                                                        loaded active listening LVM2 poll daemon socket\n  rhel-push-plugin.socket                                                     loaded active running   Docker Block RHEL push plugin Socket for the API\n  rpcbind.socket                                                              loaded active listening RPCbind Server Activation Socket\n  systemd-initctl.socket                                                      loaded active listening /dev/initctl Compatibility Named Pipe\n  systemd-journald.socket                                                     loaded active running   Journal Socket\n  systemd-shutdownd.socket                                                    loaded active listening Delayed Shutdown Socket\n  systemd-udevd-control.socket                                                loaded active running   udev Control Socket\n  systemd-udevd-kernel.socket                                                 loaded active running   udev Kernel Socket\n  virtlockd.socket                                                            loaded active listening Virtual machine lock manager socket\n  virtlogd.socket                                                             loaded active listening Virtual machine log manager socket\n  swap.file.swap                                                              loaded active active    /swap.file\n  basic.target                                                                loaded active active    Basic System\n  cryptsetup.target                                                           loaded active active    Encrypted Volumes\n  getty.target                                                                loaded active active    Login Prompts\n  local-fs-pre.target                                                         loaded active active    Local File Systems (Pre)\n  local-fs.target                                                             loaded active active    Local File Systems\n  multi-user.target                                                           loaded active active    Multi-User System\n  network-online.target                                                       loaded active active    Network is Online\n  network.target                                                              loaded active active    Network\n  nfs-client.target                                                           loaded active active    NFS client services\n  paths.target                                                                loaded active active    Paths\n  remote-fs-pre.target                                                        loaded active active    Remote File Systems (Pre)\n  remote-fs.target                                                            loaded active active    Remote File Systems\n  slices.target                                                               loaded active active    Slices\n  sockets.target                                                              loaded active active    Sockets\n  swap.target                                                                 loaded active active    Swap\n  sysinit.target                                                              loaded active active    System Initialization\n  timers.target                                                               loaded active active    Timers\n  docker-cleanup.timer                                                        loaded active waiting   Run docker-cleanup every hour\n  systemd-tmpfiles-clean.timer                                                loaded active waiting   Daily Cleanup of Temporary Directories\n  unbound-anchor.timer                                                        loaded active waiting   daily update of the root trust anchor for DNSSEC\n* openstack-swift-proxy.service                                               loaded failed failed    OpenStack Object Storage (swift) - Proxy Server\n\nLOAD   = Reflects whether the unit definition was properly loaded.\nACTIVE = The high-level unit activation state, i.e. generalization of SUB.\nSUB    = The low-level unit activation state, values depend on unit type.\n\n189 loaded units listed. Pass --all to see loaded but inactive units, too.\nTo show all installed unit files use 'systemctl list-unit-files'.\n").strip()
LISTUNITS_CONTENT_2 = ('\nsockets.target                                                              loaded active active    Sockets\nswap.target                                                                 loaded active active    Swap\nsystemd-shutdownd.socket                                                    loaded active listening Delayed Shutdown Socket\nneutron-dhcp-agent.service                                                  loaded active running   OpenStack Neutron DHCP     Agent\nneutron-openvswitch-agent.service                                           loaded active running   OpenStack Neutron Open     vSwitch Agent\nchronyd.service                                                             loaded failed failed    NTP client/server\n').strip()

def test_listunits():
    context = context_wrap(LISTUNITS_CONTENT)
    list_units = ListUnits(context)
    service_name = 'neutron-dhcp-agent.service'
    service_details = list_units.get_service_details(service_name)
    assert list_units.is_running(service_name) is True
    assert list_units.is_failed(service_name) is False
    assert service_details['UNIT'] == 'neutron-dhcp-agent.service'
    service_name = 'virtlogd.socket'
    service_details = list_units.get_service_details(service_name)
    assert service_details['SUB'] == 'listening'
    service_name = 'NetworkManager-wait-online.service'
    service_details = list_units.get_service_details(service_name)
    assert service_details['SUB'] == 'failed'
    service_name = 'ovirt-guest-agent.service'
    service_details = list_units.get_service_details(service_name)
    assert service_details['ACTIVE'] == 'failed'
    service_name = 'docker-storage-setup.service'
    assert list_units.is_running(service_name) is False
    assert list_units.is_failed(service_name) is True
    service_name = 'openstack-swift-proxy.service'
    service_details = list_units.get_service_details(service_name)
    assert service_details['SUB'] == 'failed'
    context = context_wrap(LISTUNITS_CONTENT_2)
    list_units = ListUnits(context)
    service_name = 'systemd-shutdownd.socket'
    assert list_units.is_active(service_name) is True
    assert list_units.is_running(service_name) is False
    service_details = list_units.get_service_details(service_name)
    assert service_details['UNIT'] == 'systemd-shutdownd.socket'
    service_name = 'random.service'
    service_details = list_units.get_service_details(service_name)
    assert service_details['ACTIVE'] is None
    service_name = 'chronyd.service'
    assert list_units.is_active(service_name) is False
    assert list_units.is_failed(service_name) is True
    return


LISTUNITS_CONTENT_3 = ("\nUNIT                                                                                LOAD   ACTIVE SUB       DESCRIPTION\nproc-sys-fs-binfmt_misc.automount                                                   loaded active waiting   Arbitrary Executable File Formats File System Automount Point\nsys-devices-pci0000:00-0000:00:01.1-ata1-host0-target0:0:0-0:0:0:0-block-sr0.device loaded active plugged   QEMU_DVD-ROM\nsys-devices-pci0000:00-0000:00:03.0-virtio0-net-eth0.device                         loaded active plugged   Virtio network device\nsys-devices-pci0000:00-0000:00:04.0-sound-card0.device                              loaded active plugged   82801FB/FBM/FR/FW/FRW (ICH6 Family) High Definition Audio Controller (QEMU Virtual Machine)\nsys-devices-pci0000:00-0000:00:06.0-virtio1-virtio-ports-vport1p1.device         loaded active plugged   /sys/devices/pci0000:00/0000:00:06.0/virtio1/virtio-ports/vport1p1\nsys-devices-pci0000:00-0000:00:06.0-virtio1-virtio-ports-vport1p2.device         loaded active plugged   /sys/devices/pci0000:00/0000:00:06.0/virtio1/virtio-ports/vport1p2\nsys-devices-pci0000:00-0000:00:07.0-virtio2-block-vda-vda1.device                   loaded active plugged   /sys/devices/pci0000:00/0000:00:07.0/virtio2/block/vda/vda1\nsys-devices-pci0000:00-0000:00:07.0-virtio2-block-vda-vda2.device                   loaded active plugged   LVM PV m1dNfE-0R8d-dbBp-n4F9-mT11-dffC-M4S0wq on /dev/vda2 2\nsys-devices-pci0000:00-0000:00:07.0-virtio2-block-vda.device                        loaded active plugged   /sys/devices/pci0000:00/0000:00:07.0/virtio2/block/vda\ninsights-client.timer                                                               loaded active waiting   Insights Client Timer Task\nsystemd-tmpfiles-clean.timer                                                        loaded active waiting   Daily Cleanup of Temporary Directories\nunbound-anchor.timer                                                                loaded active waiting   daily update of the root trust anchor for DNSSEC\n\nLOAD   = Reflects whether the unit definition was properly loaded.\nACTIVE = The high-level unit activation state, i.e. generalization of SUB.\nSUB    = The low-level unit activation state, values depend on unit type.\n\n161 loaded units listed. Pass --all to see loaded but inactive units, too.\nTo show all installed unit files use 'systemctl list-unit-files'.\n").strip()

def test_listunits_headings():
    list_units = ListUnits(context_wrap(LISTUNITS_CONTENT_3))
    assert set(list_units.service_names) == set([
     'proc-sys-fs-binfmt_misc.automount',
     'sys-devices-pci0000:00-0000:00:01.1-ata1-host0-target0:0:0-0:0:0:0-block-sr0.device',
     'sys-devices-pci0000:00-0000:00:03.0-virtio0-net-eth0.device',
     'sys-devices-pci0000:00-0000:00:04.0-sound-card0.device',
     'sys-devices-pci0000:00-0000:00:06.0-virtio1-virtio-ports-vport1p1.device',
     'sys-devices-pci0000:00-0000:00:06.0-virtio1-virtio-ports-vport1p2.device',
     'sys-devices-pci0000:00-0000:00:07.0-virtio2-block-vda-vda1.device',
     'sys-devices-pci0000:00-0000:00:07.0-virtio2-block-vda-vda2.device',
     'sys-devices-pci0000:00-0000:00:07.0-virtio2-block-vda.device',
     'insights-client.timer',
     'systemd-tmpfiles-clean.timer',
     'unbound-anchor.timer'])
    assert list_units.get_service_details('insights-client.timer')['DESCRIPTION'] == 'Insights Client Timer Task'


LISTUNITS_DOCTEST = ("\nUNIT                                LOAD   ACTIVE SUB       DESCRIPTION\nsockets.target                      loaded active active    Sockets\nswap.target                         loaded active active    Swap\nsystemd-shutdownd.socket            loaded active listening Delayed Shutdown Socket\nneutron-dhcp-agent.service          loaded active running   OpenStack Neutron DHCP Agent\nneutron-openvswitch-agent.service   loaded active running   OpenStack Neutron Open vSwitch Agent\n...\nunbound-anchor.timer                loaded active waiting   daily update of the root trust anchor for DNSSEC\n\nLOAD   = Reflects whether the unit definition was properly loaded.\nACTIVE = The high-level unit activation state, i.e. generalization of SUB.\nSUB    = The low-level unit activation state, values depend on unit type.\n\n161 loaded units listed. Pass --all to see loaded but inactive units, too.\nTo show all installed unit files use 'systemctl list-unit-files'.\n").strip()
UNITFILES_DOCTEST = ('\nUNIT FILE                                     STATE\nmariadb.service                               enabled\nneutron-openvswitch-agent.service             enabled\nneutron-ovs-cleanup.service                   enabled\nneutron-server.service                        enabled\nrunlevel0.target                              disabled\nrunlevel1.target                              disabled\nrunlevel2.target                              enabled\n').strip()

def test_unitfiles_doc_examples():
    env = {'conf': UnitFiles(context_wrap(UNITFILES_DOCTEST)), 
       'units': ListUnits(context_wrap(LISTUNITS_DOCTEST))}
    failed, total = doctest.testmod(unitfiles, globs=env)
    assert failed == 0