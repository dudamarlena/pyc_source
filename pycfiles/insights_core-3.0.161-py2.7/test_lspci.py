# uncompyle6 version 3.7.4
# Python bytecode 2.7 (62211)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: build/bdist.linux-x86_64/egg/insights/parsers/tests/test_lspci.py
# Compiled at: 2019-05-16 13:41:33
from insights.parsers import lspci
from insights.parsers.lspci import LsPci
from insights.tests import context_wrap
import doctest
LSPCI_0 = ('\n00:00.0 Host bridge: Intel Corporation 2nd Generation Core Processor Family DRAM Controller (rev 09)\n00:02.0 VGA compatible controller: Intel Corporation 2nd Generation Core Processor Family Integrated Graphics Controller (rev 09)\n03:00.0 Network controller: Intel Corporation Centrino Advanced-N 6205 [Taylor Peak] (rev 34)\n0d:00.0 System peripheral: Ricoh Co Ltd PCIe SDXC/MMC Host Controller (rev 07)\n').strip()
INTEL = ('\n00:00.0 Host bridge: Intel Corporation 2nd Generation Core Processor Family DRAM Controller (rev 09)\n00:02.0 VGA compatible controller: Intel Corporation 2nd Generation Core Processor Family Integrated Graphics Controller (rev 09)\n03:00.0 Network controller: Intel Corporation Centrino Advanced-N 6205 [Taylor Peak] (rev 34)\n').strip()
OTHER = ('\n05:00.0 PCI bridge: Renesas Technology Corp. Device 001d\n06:00.0 PCI bridge: Renesas Technology Corp. Device 001d\n07:00.0 PCI bridge: Renesas Technology Corp. Device 001a\n7f:14.4 System peripheral: Intel Corporation Xeon E5 v3/Core i7 DDRIO (VMSE) 0 & 1 (rev 02)\n7f:14.5 System peripheral: Intel Corporation Xeon E5 v3/Core i7 DDRIO (VMSE) 0 & 1 (rev 02)\n7f:14.6 System peripheral: Intel Corporation Xeon E5 v3/Core i7 DDRIO (VMSE) 0 & 1 (rev 02)\n7f:14.7 System peripheral: Intel Corporation Xeon E5 v3/Core i7 DDRIO (VMSE) 0 & 1 (rev 02)\n').strip()
RENESAS = ('\n05:00.0 PCI bridge: Renesas Technology Corp. Device 001d\n06:00.0 PCI bridge: Renesas Technology Corp. Device 001d\n07:00.0 PCI bridge: Renesas Technology Corp. Device 001a\n').strip()
LSPCI_DRIVER_DETAILS = ('\n00:00.0 Host bridge: Intel Corporation 5500 I/O Hub to ESI Port (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n00:01.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 1 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:02.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 2 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:03.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 3 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:07.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 7 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:08.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 8 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:09.0 PCI bridge: Intel Corporation 7500/5520/5500/X58 I/O Hub PCI Express Root Port 9 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:0a.0 PCI bridge: Intel Corporation 7500/5520/5500/X58 I/O Hub PCI Express Root Port 10 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:10.0 PIC: Intel Corporation 7500/5520/5500/X58 Physical and Link Layer Registers Port 0 (rev 13)\n        Subsystem: Device 0037:0001\n00:10.1 PIC: Intel Corporation 7500/5520/5500/X58 Routing and Protocol Layer Registers Port 0 (rev 13)\n        Subsystem: Device 0037:0001\n00:11.0 PIC: Intel Corporation 7500/5520/5500 Physical and Link Layer Registers Port 1 (rev 13)\n        Subsystem: Device 0037:0001\n00:11.1 PIC: Intel Corporation 7500/5520/5500 Routing & Protocol Layer Register Port 1 (rev 13)\n        Subsystem: Device 0037:0001\n00:13.0 PIC: Intel Corporation 7500/5520/5500/X58 I/O Hub I/OxAPIC Interrupt Controller (rev 13)\n        Subsystem: Device 0037:0001\n00:14.0 PIC: Intel Corporation 7500/5520/5500/X58 I/O Hub System Management Registers (rev 13)\n        Subsystem: Device 0037:0001\n        Kernel modules: i7core_edac\n00:14.1 PIC: Intel Corporation 7500/5520/5500/X58 I/O Hub GPIO and Scratch Pad Registers (rev 13)\n        Subsystem: Device 0037:0001\n00:14.2 PIC: Intel Corporation 7500/5520/5500/X58 I/O Hub Control Status and RAS Registers (rev 13)\n        Subsystem: Device 0037:0001\n00:14.3 PIC: Intel Corporation 7500/5520/5500/X58 I/O Hub Throttle Registers (rev 13)\n        Subsystem: Device 0037:0001\n00:16.0 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.1 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.2 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.3 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.4 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.5 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.6 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:16.7 System peripheral: Intel Corporation 5520/5500/X58 Chipset QuickData Technology Device (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ioatdma\n        Kernel modules: ioatdma\n00:1a.0 USB controller: Intel Corporation 82801JI (ICH10 Family) USB UHCI Controller #4\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: uhci_hcd\n00:1a.1 USB controller: Intel Corporation 82801JI (ICH10 Family) USB UHCI Controller #5\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: uhci_hcd\n00:1a.2 USB controller: Intel Corporation 82801JI (ICH10 Family) USB UHCI Controller #6\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: uhci_hcd\n00:1a.7 USB controller: Intel Corporation 82801JI (ICH10 Family) USB2 EHCI Controller #2\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ehci_hcd\n00:1c.0 PCI bridge: Intel Corporation 82801JI (ICH10 Family) PCI Express Root Port 1\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:1c.4 PCI bridge: Intel Corporation 82801JI (ICH10 Family) PCI Express Root Port 5\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:1c.5 PCI bridge: Intel Corporation 82801JI (ICH10 Family) PCI Express Root Port 6\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:1d.0 USB controller: Intel Corporation 82801JI (ICH10 Family) USB UHCI Controller #1\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: uhci_hcd\n00:1d.1 USB controller: Intel Corporation 82801JI (ICH10 Family) USB UHCI Controller #2\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: uhci_hcd\n00:1d.2 USB controller: Intel Corporation 82801JI (ICH10 Family) USB UHCI Controller #3\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: uhci_hcd\n00:1d.7 USB controller: Intel Corporation 82801JI (ICH10 Family) USB2 EHCI Controller #1\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: ehci_hcd\n00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev 90)\n00:1f.0 ISA bridge: Intel Corporation 82801JIR (ICH10R) LPC Interface Controller\n        Subsystem: Cisco Systems Inc Device 0101\n        Kernel driver in use: lpc_ich\n        Kernel modules: lpc_ich\n01:00.0 SCSI storage controller: LSI Logic / Symbios Logic SAS1064ET PCI-Express Fusion-MPT SAS (rev 08)\n        Subsystem: Cisco Systems Inc Device 0049\n        Kernel driver in use: mptsas\n        Kernel modules: mptsas\n04:00.0 Fibre Channel: QLogic Corp. ISP2432-based 4Gb Fibre Channel to PCI Express HBA (rev 03)\n        Subsystem: Cisco Systems Inc Device 004a\n        Kernel driver in use: qla2xxx\n        Kernel modules: qla2xxx\n04:00.1 Fibre Channel: QLogic Corp. ISP2432-based 4Gb Fibre Channel to PCI Express HBA (rev 03)\n        Subsystem: Cisco Systems Inc Device 004a\n        Kernel driver in use: qla2xxx\n        Kernel modules: qla2xxx\n06:00.0 Ethernet controller: Intel Corporation 82598EB 10-Gigabit AF Dual Port Network Connection (rev 01)\n        Subsystem: Cisco Systems Inc Device 004a\n        Kernel driver in use: ixgbe\n        Kernel modules: ixgbe\n06:00.1 Ethernet controller: Intel Corporation 82598EB 10-Gigabit AF Dual Port Network Connection (rev 01)\n        Subsystem: Cisco Systems Inc Device 004a\n        Kernel driver in use: ixgbe\n        Kernel modules: ixgbe\n09:00.0 VGA compatible controller: Matrox Electronics Systems Ltd. MGA G200e [Pilot] ServerEngines (SEP1) (rev 02)\n        Subsystem: Cisco Systems Inc Device 0101\n').strip()
LSPCI_DRIVER_DETAILS_2 = ('\n04:00.0 Fibre Channel: QLogic Corp. ISP2432-based 4Gb Fibre Channel to PCI Express HBA (rev 03)\n04:00.1 Fibre Channel: QLogic Corp. ISP2432-based 4Gb Fibre Channel to PCI Express HBA (rev 03)\n06:00.1 Ethernet controller: Intel Corporation 82598EB 10-Gigabit AF Dual Port Network Connection (rev 01)\n09:00.0 VGA compatible controller: Matrox Electronics Systems Ltd. MGA G200e [Pilot] ServerEngines (SEP1) (rev 02)\nVGA compatible controller: Matrox Electronics Systems Ltd:MGA G200e [Pilot] ServerEngines (SEP1) (rev 02)\n').strip()
LSPCI_DRIVER_DETAILS_3 = ('\nEthernet controller: Intel Corporation 82598EB 10-Gigabit AF Dual Port Network Connection (rev 01)\nVGA compatible controller: Matrox Electronics Systems Ltd:MGA G200e [Pilot] ServerEngines (SEP1) (rev 02)\n').strip()
LSPCI_DRIVER_DOC = ('\n00:00.0 Host bridge: Intel Corporation 5500 I/O Hub to ESI Port (rev 13)\n        Subsystem: Cisco Systems Inc Device 0101\n00:01.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 1 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n00:02.0 PCI bridge: Intel Corporation 5520/5500/X58 I/O Hub PCI Express Root Port 2 (rev 13)\n        Kernel driver in use: pcieport\n        Kernel modules: shpchp\n03:00.0 Network controller: Intel Corporation Centrino Advanced-N 6205 [Taylor Peak] (rev 34)\n        Subsystem: Cisco Systems Inc Device 004a\n        Kernel driver in use: ixgbe\n        Kernel modules: ixgbe\n06:00.0 Ethernet controller: Intel Corporation 82598EB 10-Gigabit AF Dual Port Network Connection (rev 01)\n        Subsystem: Cisco Systems Inc Device 004a\n        Kernel driver in use: ixgbe\n        Kernel modules: ixgbe\n').strip()
LSPCI_OUTPUT_WITH_BAD_LINES = ('\n03:00.0 Network controller: Intel Corporation Wireless 7260 (rev bb)\n        Subsystem: Intel Corporation Dual Band Wireless-AC 7260\n\n        Kernel driver in use: iwlwifi\n# a comment\n        Kernel modules: iwlwifi\n').strip()

def test_lspci():
    LsPci.token_scan('centrino', 'Centrino')
    lspci_0 = LsPci(context_wrap(LSPCI_0))
    assert [ i['raw_message'] for i in lspci_0.get('Intel Corporation') ] == INTEL.splitlines()
    assert len(lspci_0.get('Network controller')) == 1
    assert 'Centrino Advanced-N 6205' in lspci_0
    assert '0d:00.0' in lspci_0
    other = LsPci(context_wrap(OTHER))
    assert [ i['raw_message'] for i in other.get('Renesas Technology Corp.') ] == RENESAS.splitlines()
    assert len(other.get('Xeon E5 v3')) == 4
    assert len(other.get('001a')) == 1
    assert 'Core i7' in other


def test_lspci_driver():
    lspci_obj = LsPci(context_wrap(LSPCI_DRIVER_DETAILS))
    assert len(lspci_obj.data) == 44
    dev_info = lspci_obj.pci_dev_details('00:01.0')
    assert len(dev_info) == 3
    assert dev_info['Kernel driver in use'] == 'pcieport'
    assert len(lspci_obj.pci_dev_list) == 44
    lspci_obj = LsPci(context_wrap(LSPCI_DRIVER_DETAILS_2))
    assert len(lspci_obj.data) == 4
    dev_info = lspci_obj.pci_dev_details('04:00.0')
    assert len(dev_info) == 1
    assert 'Kernel driver in use' not in dev_info
    assert len(lspci_obj.pci_dev_list) == 4
    lspci_obj = LsPci(context_wrap(LSPCI_DRIVER_DETAILS_3))
    assert len(lspci_obj.data) == 0
    assert len(lspci_obj.pci_dev_list) == 0
    output = LsPci(context_wrap(LSPCI_OUTPUT_WITH_BAD_LINES))
    assert len(output.data) == 1
    assert len(output.pci_dev_list) == 1


def test_doc_examples():
    env = {'lspci': LsPci(context_wrap(LSPCI_DRIVER_DOC))}
    failed, total = doctest.testmod(lspci, globs=env)
    assert failed == 0