# uncompyle6 version 3.7.4
# Python bytecode 2.7 (62211)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: build/bdist.linux-x86_64/egg/insights/parsers/tests/test_qemu_xml.py
# Compiled at: 2019-11-14 13:57:46
import doctest
from insights.parsers import qemu_xml
from insights.tests import context_wrap
XML_NUMA = "\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit 05-s00c06h0\nor other application using the libvirt API.\n-->\n\n<domain type='kvm'>\n  <name>05-s00c06h0</name>\n  <uuid>02cf0bba-2bd6-11e7-8337-e4115b9a50d0</uuid>\n  <memory unit='KiB'>12582912</memory>\n  <currentMemory unit='KiB'>12582912</currentMemory>\n  <vcpu placement='static'>4</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <emulatorpin cpuset='1-4'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0-1'/>\n    <memnode cellid='0' mode='strict' nodeset='0'/>\n    <memnode cellid='1' mode='strict' nodeset='1'/>\n  </numatune>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-rhel7.0.0'>hvm</type>\n    <boot dev='hd'/>\n    <boot dev='network'/>\n    <bootmenu enable='yes' timeout='1000'/>\n    <bios useserial='yes' rebootTimeout='0'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n    <pae/>\n  </features>\n  <cpu>\n    <numa>\n      <cell id='0' cpus='0-1' memory='6291456' unit='KiB'/>\n      <cell id='1' cpus='2-3' memory='6291456' unit='KiB'/>\n    </numa>\n  </cpu>\n  <clock offset='utc'/>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>restart</on_crash>\n  <devices>\n    <emulator>/usr/libexec/qemu-kvm</emulator>\n    <disk type='file' device='disk'>\n      <driver name='qemu' type='raw' cache='none' io='threads'/>\n      <source file='/var/lib/libvirt/images/05-s00c06h0_1.img'/>\n      <target dev='vda' bus='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'/>\n    <controller type='virtio-serial' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </controller>\n    <interface type='hostdev' managed='yes'>\n      <mac address='aa:ss:bb:cc:dd:ee'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x04' slot='0x10' function='0x0'/>\n      </source>\n      <rom bar='on' file='/opt/vcp/share/ipxe/808610ed.rom'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </interface>\n    <interface type='hostdev' managed='yes'>\n      <mac address='bb:55:77:11:00:00'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x04' slot='0x10' function='0x1'/>\n      </source>\n      <rom bar='on' file='/opt/vcp/share/ipxe/808610ed.rom'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <target port='0'/>\n    </serial>\n    <console type='pty'>\n      <target type='serial' port='0'/>\n    </console>\n    <channel type='pipe'>\n      <source path='/var/lib/libvirt/qemu/channels/FROM-05-s00c06h0'/>\n      <target type='virtio' name='virtio2host'/>\n      <address type='virtio-serial' controller='0' bus='0' port='1'/>\n    </channel>\n    <channel type='pipe'>\n      <source path='/var/lib/libvirt/qemu/channels/HGC-05-s00c06h0'/>\n      <target type='virtio' name='virtio_host_guest_check'/>\n      <address type='virtio-serial' controller='0' bus='0' port='2'/>\n    </channel>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='vnc' port='-1' autoport='yes'>\n      <listen type='address'/>\n    </graphics>\n    <video>\n      <model type='cirrus' vram='16384' heads='1' primary='yes'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <watchdog model='i6300esb' action='reset'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </watchdog>\n    <memballoon model='virtio'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </memballoon>\n  </devices>\n</domain>\n"
XML_NUMA_NO_NAME = "\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit 05-s00c06h0\nor other application using the libvirt API.\n-->\n\n<domain type='kvm'>\n  <uuid>02cf0bba-2bd6-11e7-8337-e4115b9a50d0</uuid>\n  <memory unit='KiB'>12582912</memory>\n</domain>\n"
BLANK_XML = '\n'
RHEL_7_4_XML = "\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit rhel7.4\nor other application using the libvirt API.\n-->\n\n<domain type='kvm'>\n  <name>rhel7.4</name>\n  <uuid>b75610eb-06a0-4834-8286-e3d25d79c593</uuid>\n  <memory unit='KiB'>4194304</memory>\n  <currentMemory unit='KiB'>4194304</currentMemory>\n  <vcpu placement='static'>4</vcpu>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-2.10'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n    <vmport state='off'/>\n  </features>\n  <cpu mode='custom' match='exact' check='partial'>\n    <model fallback='allow'>Haswell-noTSX</model>\n  </cpu>\n  <clock offset='utc'>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <pm>\n    <suspend-to-mem enabled='no'/>\n    <suspend-to-disk enabled='no'/>\n  </pm>\n  <devices>\n    <emulator>/usr/bin/qemu-kvm</emulator>\n    <disk type='file' device='disk'>\n      <driver name='qemu' type='qcow2'/>\n      <source file='/var/lib/libvirt/images/rhel-7.4-insights.qcow2'/>\n      <target dev='vda' bus='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0' model='ich9-ehci1'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x7'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci1'>\n      <master startport='0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0' multifunction='on'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci2'>\n      <master startport='2'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x1'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci3'>\n      <master startport='4'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'/>\n    <controller type='virtio-serial' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </controller>\n    <interface type='network'>\n      <mac address='aa:ss:bb:ff:ee:mm'/>\n      <source network='default'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <target port='0'/>\n    </serial>\n    <console type='pty'>\n      <target type='serial' port='0'/>\n    </console>\n    <channel type='unix'>\n      <target type='virtio' name='org.qemu.guest_agent.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='1'/>\n    </channel>\n    <channel type='spicevmc'>\n      <target type='virtio' name='com.redhat.spice.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='2'/>\n    </channel>\n    <input type='tablet' bus='usb'>\n      <address type='usb' bus='0' port='1'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='spice' autoport='yes'>\n      <listen type='address'/>\n      <image compression='off'/>\n    </graphics>\n    <sound model='ich6'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </sound>\n    <video>\n      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='2'/>\n    </redirdev>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='3'/>\n    </redirdev>\n    <memballoon model='virtio'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/>\n    </memballoon>\n  </devices>\n</domain>\n"
XML_IDM_CLIENT = ('\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit test-idm-client-ccveu-net\nor other application using the libvirt API.\n-->\n\n<domstatus state=\'running\' reason=\'unpaused\' pid=\'17150\'>\n  <monitor path=\'/var/lib/libvirt/qemu/domain-59-test-idm-client-ccve/monitor.sock\' json=\'1\' type=\'unix\'/>\n  <vcpus>\n    <vcpu id=\'0\' pid=\'17156\'/>\n    <vcpu id=\'1\' pid=\'17157\'/>\n  </vcpus>\n  <qemuCaps>\n    <flag name=\'kvm\'/>\n    <flag name=\'mem-path\'/>\n    <flag name=\'ivshmem-doorbell\'/>\n  </qemuCaps>\n  <devices>\n    <device alias=\'balloon0\'/>\n    <device alias=\'virtio-disk0\'/>\n    <device alias=\'ide0-1-0\'/>\n  </devices>\n  <libDir path=\'/var/lib/libvirt/qemu/domain-59-test-idm-client-ccve\'/>\n  <channelTargetDir path=\'/var/lib/libvirt/qemu/channel/target/domain-59-test-idm-client-ccve\'/>\n  <domain type=\'kvm\' id=\'59\'>\n    <name>test-idm-client-ccveu-net</name>\n    <uuid>78177d07-ac0e-4057-b1de-9ccd66cbc3d7</uuid>\n    <metadata xmlns:ovirt="http://ovirt.org/vm/tune/1.0">\n      <ovirt:qos/>\n    </metadata>\n    <maxMemory slots=\'16\' unit=\'KiB\'>4294967296</maxMemory>\n    <memory unit=\'KiB\'>2097152</memory>\n    <currentMemory unit=\'KiB\'>2097152</currentMemory>\n    <vcpu placement=\'static\' current=\'2\'>32</vcpu>\n    <cputune>\n      <shares>1020</shares>\n    </cputune>\n    <resource>\n      <partition>/machine</partition>\n    </resource>\n    <sysinfo type=\'smbios\'>\n      <system>\n        <entry name=\'manufacturer\'>Red Hat</entry>\n        <entry name=\'product\'>RHEV Hypervisor</entry>\n        <entry name=\'version\'>7.3-1.1.el7</entry>\n        <entry name=\'serial\'>49c1e6bb-adbb-44ac-8d12-5ba4119cf110</entry>\n        <entry name=\'uuid\'>78177d07-ac0e-4057-b1de-9ccd66cbc3d7</entry>\n      </system>\n    </sysinfo>\n    <os>\n      <type arch=\'x86_64\' machine=\'pc-i440fx-rhel7.2.0\'>hvm</type>\n      <bootmenu enable=\'yes\' timeout=\'10000\'/>\n      <smbios mode=\'sysinfo\'/>\n    </os>\n    <features>\n      <acpi/>\n    </features>\n    <cpu mode=\'custom\' match=\'exact\'>\n      <model fallback=\'allow\'>Broadwell</model>\n      <topology sockets=\'16\' cores=\'2\' threads=\'1\'/>\n      <numa>\n        <cell id=\'0\' cpus=\'0-1\' memory=\'2097152\' unit=\'KiB\'/>\n      </numa>\n    </cpu>\n    <clock offset=\'variable\' adjustment=\'1\' basis=\'utc\'>\n      <timer name=\'rtc\' tickpolicy=\'catchup\'/>\n      <timer name=\'pit\' tickpolicy=\'delay\'/>\n      <timer name=\'hpet\' present=\'no\'/>\n    </clock>\n    <on_poweroff>destroy</on_poweroff>\n    <on_reboot>restart</on_reboot>\n    <on_crash>destroy</on_crash>\n    <devices>\n      <emulator>/usr/libexec/qemu-kvm</emulator>\n      <disk type=\'file\' device=\'cdrom\'>\n        <driver name=\'qemu\' type=\'raw\'/>\n        <source startupPolicy=\'optional\'/>\n        <backingStore/>\n        <target dev=\'hdc\' bus=\'ide\'/>\n        <readonly/>\n        <alias name=\'ide0-1-0\'/>\n        <address type=\'drive\' controller=\'0\' bus=\'1\' target=\'0\' unit=\'0\'/>\n      </disk>\n      <controller type=\'usb\' index=\'0\' model=\'piix3-uhci\'>\n        <alias name=\'usb\'/>\n        <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x01\' function=\'0x2\'/>\n      </controller>\n      <interface type=\'bridge\'>\n        <mac address=\'00:1a:4a:16:03:72\'/>\n        <source bridge=\'vlan2593\'/>\n        <target dev=\'vnet20\'/>\n        <model type=\'virtio\'/>\n        <filterref filter=\'vdsm-no-mac-spoofing\'/>\n        <link state=\'up\'/>\n        <boot order=\'2\'/>\n        <alias name=\'net0\'/>\n        <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x03\' function=\'0x0\'/>\n      </interface>\n      <channel type=\'unix\'>\n        <source mode=\'bind\' path=\'/var/lib/libvirt/qemu/channels/78177d07-ac0e-4057-b1de-9ccd66cbc3d7.com.redhat.rhevm.vdsm\'/>\n        <target type=\'virtio\' name=\'com.redhat.rhevm.vdsm\' state=\'connected\'/>\n        <alias name=\'channel0\'/>\n        <address type=\'virtio-serial\' controller=\'0\' bus=\'0\' port=\'1\'/>\n      </channel>\n      <input type=\'mouse\' bus=\'ps2\'>\n        <alias name=\'input0\'/>\n      </input>\n    </devices>\n    <seclabel type=\'dynamic\' model=\'dac\' relabel=\'yes\'>\n      <label>+107:+107</label>\n      <imagelabel>+107:+107</imagelabel>\n    </seclabel>\n  </domain>\n</domstatus>\n').strip()
XML_IDM_CLIENT_NO_NAME = ("\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit test-idm-client-ccveu-net\nor other application using the libvirt API.\n-->\n\n<domstatus state='running' reason='unpaused' pid='17150'>\n  <monitor path='/var/lib/libvirt/qemu/domain-59-test-idm-client-ccve/monitor.sock' json='1' type='unix'/>\n  <vcpus>\n    <vcpu id='0' pid='17156'/>\n    <vcpu id='1' pid='17157'/>\n  </vcpus>\n  <libDir path='/var/lib/libvirt/qemu/domain-59-test-idm-client-ccve'/>\n  <channelTargetDir path='/var/lib/libvirt/qemu/channel/target/domain-59-test-idm-client-ccve'/>\n  <domain type='kvm' id='59'>\n    <uuid>78177d07-ac0e-4057-b1de-9ccd66cbc3d7</uuid>\n  </domain>\n</domstatus>\n").strip()
XML_RHOSP = ('\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit instance-000008d6\nor other application using the libvirt API.\n-->\n\n<domain type=\'kvm\'>\n  <name>instance-000008d6</name>\n  <uuid>601da52c-450f-4d8e-b502-503431536fa69</uuid>\n  <metadata>\n    <nova:instance xmlns:nova="http://openstack.org/xmlns/libvirt/nova/1.0">\n      <nova:package version="14.0.3-8.el7ost"/>\n      <nova:name>django_vm_001</nova:name>\n      <nova:creationTime>2017-10-09 08:51:28</nova:creationTime>\n      <nova:flavor name="vpc1-cf1-foo-bar">\n        <nova:memory>8096</nova:memory>\n        <nova:disk>10</nova:disk>\n        <nova:swap>0</nova:swap>\n        <nova:ephemeral>0</nova:ephemeral>\n        <nova:vcpus>4</nova:vcpus>\n      </nova:flavor>\n      <nova:owner>\n        <nova:user uuid="96e9d2b749ea48fcb5a911e6f0e144f2">django_user_01</nova:user>\n        <nova:project uuid="5a50e9d0d19746158958be0c759793fb">vpcdi1</nova:project>\n      </nova:owner>\n      <nova:root type="image" uuid="1a05a423-dfae-428a-ae54-1614d8024e76"/>\n    </nova:instance>\n  </metadata>\n  <memory unit=\'KiB\'>8290304</memory>\n  <currentMemory unit=\'KiB\'>8290304</currentMemory>\n  <vcpu placement=\'static\'>4</vcpu>\n  <cputune>\n    <shares>4096</shares>\n    <vcpupin vcpu=\'0\' cpuset=\'1\'/>\n    <vcpupin vcpu=\'1\' cpuset=\'2\'/>\n    <vcpupin vcpu=\'2\' cpuset=\'13\'/>\n    <vcpupin vcpu=\'3\' cpuset=\'14\'/>\n    <emulatorpin cpuset=\'1-2,13-14\'/>\n  </cputune>\n  <numatune>\n    <memory mode=\'strict\' nodeset=\'0-1\'/>\n    <memnode cellid=\'0\' mode=\'strict\' nodeset=\'0\'/>\n    <memnode cellid=\'1\' mode=\'strict\' nodeset=\'1\'/>\n  </numatune>\n  <sysinfo type=\'smbios\'>\n    <system>\n      <entry name=\'manufacturer\'>Red Hat</entry>\n      <entry name=\'product\'>OpenStack Compute</entry>\n      <entry name=\'version\'>14.0.3-8.el7ost</entry>\n      <entry name=\'serial\'>1b52c42f-b1eb-47f4-a8c0-9904d4735fc9</entry>\n      <entry name=\'uuid\'>601da52c-450f-4d8e-b502-50151536fa69</entry>\n      <entry name=\'family\'>Virtual Machine</entry>\n    </system>\n  </sysinfo>\n  <os>\n    <type arch=\'x86_64\' machine=\'pc-i440fx-rhel7.3.0\'>hvm</type>\n    <boot dev=\'hd\'/>\n    <smbios mode=\'sysinfo\'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode=\'host-passthrough\'>\n    <topology sockets=\'4\' cores=\'1\' threads=\'1\'/>\n    <numa>\n      <cell id=\'0\' cpus=\'0-1\' memory=\'4145152\' unit=\'KiB\'/>\n      <cell id=\'1\' cpus=\'2-3\' memory=\'4145152\' unit=\'KiB\'/>\n    </numa>\n  </cpu>\n  <clock offset=\'utc\'>\n    <timer name=\'pit\' tickpolicy=\'delay\'/>\n    <timer name=\'rtc\' tickpolicy=\'catchup\'/>\n    <timer name=\'hpet\' present=\'no\'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/libexec/qemu-kvm</emulator>\n    <disk type=\'file\' device=\'disk\'>\n      <driver name=\'qemu\' type=\'qcow2\' cache=\'none\'/>\n      <source file=\'/var/lib/nova/instances/601da52c-450f-4d8e-b502-50151536fa69/disk\'/>\n      <target dev=\'vda\' bus=\'virtio\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x04\' function=\'0x0\'/>\n    </disk>\n    <disk type=\'block\' device=\'disk\'>\n      <driver name=\'qemu\' type=\'raw\' cache=\'none\' io=\'native\'/>\n      <source dev=\'/dev/disk/by-id/dm-uuid-mpath-3600a09803830316d512b4a6b38374143\'/>\n      <target dev=\'vdb\' bus=\'virtio\'/>\n      <serial>dd036ba1-bb5f-4c1a-a369-a918080bff7f</serial>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x05\' function=\'0x0\'/>\n    </disk>\n    <controller type=\'usb\' index=\'0\'>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x01\' function=\'0x2\'/>\n    </controller>\n    <controller type=\'pci\' index=\'0\' model=\'pci-root\'/>\n    <interface type=\'bridge\'>\n      <mac address=\'aa:aa:ee:bb:10:aa\'/>\n      <source bridge=\'qbrf975e53f-e0\'/>\n      <target dev=\'tapf975e53f-e0\'/>\n      <model type=\'virtio\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x03\' function=\'0x0\'/>\n    </interface>\n    <serial type=\'file\'>\n      <source path=\'/var/lib/nova/instances/601da52c-450f-4d8e-b502-50151536fa69/console.log\'/>\n      <target port=\'0\'/>\n    </serial>\n    <serial type=\'pty\'>\n      <target port=\'1\'/>\n    </serial>\n    <console type=\'file\'>\n      <source path=\'/var/lib/nova/instances/601da52c-450f-4d8e-b502-50151536fa69/console.log\'/>\n      <target type=\'serial\' port=\'0\'/>\n    </console>\n    <input type=\'tablet\' bus=\'usb\'>\n      <address type=\'usb\' bus=\'0\' port=\'1\'/>\n    </input>\n    <input type=\'mouse\' bus=\'ps2\'/>\n    <input type=\'keyboard\' bus=\'ps2\'/>\n    <graphics type=\'vnc\' port=\'-1\' autoport=\'yes\' listen=\'0.0.0.0\' keymap=\'fr\'>\n      <listen type=\'address\' address=\'0.0.0.0\'/>\n    </graphics>\n    <video>\n      <model type=\'cirrus\' vram=\'16384\' heads=\'1\' primary=\'yes\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x02\' function=\'0x0\'/>\n    </video>\n    <memballoon model=\'virtio\'>\n      <stats period=\'10\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x06\' function=\'0x0\'/>\n    </memballoon>\n  </devices>\n</domain>\n').strip()
XML_RHOSP_2 = ('\n<!--\nWARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE\nOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:\n  virsh edit instance-000008d6\nor other application using the libvirt API.\n-->\n\n<domain type=\'kvm\'>\n  <name>instance-000008d7</name>\n  <uuid>601da52c-450f-4d8e-b502-503431536fa69</uuid>\n  <metadata>\n    <nova:instance xmlns:nova="http://openstack.org/xmlns/libvirt/nova/1.0">\n      <nova:package version="14.0.3-8.el7ost"/>\n      <nova:name>VM_AT_01</nova:name>\n      <nova:creationTime>2017-10-09 08:51:28</nova:creationTime>\n    </nova:instance>\n  </metadata>\n  <memory unit=\'KiB\'>8290304</memory>\n  <currentMemory unit=\'KiB\'>8290304</currentMemory>\n  <vcpu placement=\'static\'>4</vcpu>\n  <cputune>\n    <shares>4096</shares>\n    <vcpupin vcpu=\'0\' cpuset=\'1\'/>\n    <vcpupin vcpu=\'1\' cpuset=\'2\'/>\n    <vcpupin vcpu=\'2\' cpuset=\'13\'/>\n    <vcpupin vcpu=\'3\' cpuset=\'14\'/>\n    <emulatorpin cpuset=\'1-2,13-14\'/>\n  </cputune>\n  <numatune>\n    <memory mode=\'strict\' nodeset=\'0-1\'/>\n    <memnode cellid=\'0\' mode=\'strict\' nodeset=\'0\'/>\n    <memnode cellid=\'1\' mode=\'strict\' nodeset=\'1\'/>\n  </numatune>\n  <sysinfo type=\'smbios\'>\n    <system>\n      <entry name=\'manufacturer\'>Red Hat</entry>\n      <entry name=\'product\'>OpenStack Compute</entry>\n      <entry name=\'version\'>14.0.3-8.el7ost</entry>\n      <entry name=\'serial\'>1b52c42f-b1eb-47f4-a8c0-9904d4735fc9</entry>\n      <entry name=\'uuid\'>601da52c-450f-4d8e-b502-50151536fa69</entry>\n      <entry name=\'family\'>Virtual Machine</entry>\n    </system>\n  </sysinfo>\n  <os>\n    <type arch=\'x86_64\' machine=\'pc-i440fx-rhel7.3.0\'>hvm</type>\n    <boot dev=\'hd\'/>\n    <smbios mode=\'sysinfo\'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode=\'host-passthrough\'>\n    <topology sockets=\'4\' cores=\'1\' threads=\'1\'/>\n    <numa>\n      <cell id=\'0\' cpus=\'0-1\' memory=\'4145152\' unit=\'KiB\'/>\n      <cell id=\'1\' cpus=\'2-3\' memory=\'4145152\' unit=\'KiB\'/>\n    </numa>\n  </cpu>\n  <clock offset=\'utc\'>\n    <timer name=\'pit\' tickpolicy=\'delay\'/>\n    <timer name=\'rtc\' tickpolicy=\'catchup\'/>\n    <timer name=\'hpet\' present=\'no\'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <devices>\n    <emulator>/usr/libexec/qemu-kvm</emulator>\n    <disk type=\'file\' device=\'disk\'>\n      <driver name=\'qemu\' type=\'qcow2\' cache=\'none\'/>\n      <source file=\'/var/lib/nova/instances/601da52c-450f-4d8e-b502-50151536fa69/disk\'/>\n      <target dev=\'vda\' bus=\'virtio\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x04\' function=\'0x0\'/>\n    </disk>\n    <disk type=\'block\' device=\'disk\'>\n      <driver name=\'qemu\' type=\'raw\' cache=\'none\' io=\'native\'/>\n      <source dev=\'/dev/disk/by-id/dm-uuid-mpath-3600a09803830316d512b4a6b38374143\'/>\n      <target dev=\'vdb\' bus=\'virtio\'/>\n      <serial>dd036ba1-bb5f-4c1a-a369-a918080bff7f</serial>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x05\' function=\'0x0\'/>\n    </disk>\n    <controller type=\'usb\' index=\'0\'>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x01\' function=\'0x2\'/>\n    </controller>\n    <controller type=\'pci\' index=\'0\' model=\'pci-root\'/>\n    <interface type=\'bridge\'>\n      <mac address=\'aa:aa:ee:bb:10:aa\'/>\n      <source bridge=\'qbrf975e53f-e0\'/>\n      <target dev=\'tapf975e53f-e0\'/>\n      <model type=\'virtio\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x03\' function=\'0x0\'/>\n    </interface>\n    <serial type=\'file\'>\n      <source path=\'/var/lib/nova/instances/601da52c-450f-4d8e-b502-50151536fa69/console.log\'/>\n      <target port=\'0\'/>\n    </serial>\n    <serial type=\'pty\'>\n      <target port=\'1\'/>\n    </serial>\n    <console type=\'file\'>\n      <source path=\'/var/lib/nova/instances/601da52c-450f-4d8e-b502-50151536fa69/console.log\'/>\n      <target type=\'serial\' port=\'0\'/>\n    </console>\n    <input type=\'tablet\' bus=\'usb\'>\n      <address type=\'usb\' bus=\'0\' port=\'1\'/>\n    </input>\n    <input type=\'mouse\' bus=\'ps2\'/>\n    <input type=\'keyboard\' bus=\'ps2\'/>\n    <graphics type=\'vnc\' port=\'-1\' autoport=\'yes\' listen=\'0.0.0.0\' keymap=\'fr\'>\n      <listen type=\'address\' address=\'0.0.0.0\'/>\n    </graphics>\n    <video>\n      <model type=\'cirrus\' vram=\'16384\' heads=\'1\' primary=\'yes\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x02\' function=\'0x0\'/>\n    </video>\n    <memballoon model=\'virtio\'>\n      <stats period=\'10\'/>\n      <address type=\'pci\' domain=\'0x0000\' bus=\'0x00\' slot=\'0x06\' function=\'0x0\'/>\n    </memballoon>\n  </devices>\n</domain>\n').strip()

def test_vm_xml():
    xml = qemu_xml.QemuXML(context_wrap(XML_NUMA, path='/etc/libvirt/qemu/vm.xml'))
    assert xml.file_name == 'vm.xml'
    assert xml.vm_name == '05-s00c06h0'
    memnode = xml.get_elements('./numatune/memnode', None)
    assert len(memnode[0].items()) == 3
    assert len(memnode[1].items()) == 3
    xml = qemu_xml.QemuXML(context_wrap(XML_NUMA_NO_NAME, path='/etc/libvirt/qemu/no_name.xml'))
    assert xml.vm_name is None
    return


def test_rhel_7_4():
    xml = qemu_xml.QemuXML(context_wrap(RHEL_7_4_XML, path='/etc/libvirt/qemu/rhel7.4.xml'))
    assert xml.file_name == 'rhel7.4.xml'
    assert xml.vm_name == 'rhel7.4'
    os = xml.get_elements('./os/type')[0]
    assert os.get('arch') == 'x86_64'
    assert os.get('machine') == 'pc-i440fx-2.10'


def test_parse_dom():
    xml = qemu_xml.QemuXML(context_wrap(RHEL_7_4_XML, path='/etc/libvirt/qemu/rhel7.4.xml'))
    dom = xml.parse_dom()
    assert dom.get('vcpu', None) == '4'
    xml = qemu_xml.QemuXML(context_wrap(XML_NUMA_NO_NAME, path='/etc/libvirt/qemu/no_name.xml'))
    dom = xml.parse_dom()
    assert dom.get('vcpu') is None
    return


def test_blank_xml():
    xml = qemu_xml.QemuXML(context_wrap(BLANK_XML, path='/etc/libvirt/qemu/blank.xml'))
    assert xml.file_name == 'blank.xml'
    assert xml.vm_name is None
    assert xml.parse_dom() == {}
    return


def test_rhosp_xml():
    xml = qemu_xml.OpenStackInstanceXML(context_wrap(XML_RHOSP, path='/etc/libvirt/qemu/instance-000008d6.xml'))
    assert xml.domain_name == 'instance-000008d6'
    assert xml.nova.get('version') == '14.0.3-8.el7ost'
    assert xml.nova.get('instance_name') == 'django_vm_001'
    assert xml.nova.get('user') == 'django_user_01'
    assert xml.nova.get('root_disk_type') == 'image'
    assert xml.nova.get('flavor_vcpus') == '4'
    rhosp_xml_2 = qemu_xml.OpenStackInstanceXML(context_wrap(XML_RHOSP_2, path='/etc/libvirt/qemu/instance-000008d7.xml'))
    assert rhosp_xml_2.nova == {'version': '14.0.3-8.el7ost', 'instance_name': 'VM_AT_01', 'created': '2017-10-09 08:51:28'}
    assert rhosp_xml_2.domain_name == 'instance-000008d7'
    xml = qemu_xml.OpenStackInstanceXML(context_wrap(XML_NUMA, path='/etc/libvirt/qemu/numa_instance_001.xml'))
    assert xml.domain_name == 'numa_instance_001'
    xml = qemu_xml.OpenStackInstanceXML(context_wrap(XML_IDM_CLIENT, path='/etc/libvirt/qemu/idm_001.xml'))
    assert xml.domain_name == 'idm_001'


def test_documentation():
    env = {'xml_numa': qemu_xml.QemuXML(context_wrap(XML_NUMA, path='/etc/libvirt/qemu/vm.xml')), 'rhosp_xml': qemu_xml.OpenStackInstanceXML(context_wrap(XML_RHOSP, path='/etc/libvirt/qemu/instance-000008d6.xml'))}
    failed_count, tests = doctest.testmod(qemu_xml, globs=env)
    assert failed_count == 0


def test_var_qemu_xml():
    xml = qemu_xml.VarQemuXML(context_wrap(XML_IDM_CLIENT, path='/var/run/libvirt/qemu/test-idm-client-ccveu-net.xml'))
    assert xml.file_name == 'test-idm-client-ccveu-net.xml'
    assert xml.vm_name == 'test-idm-client-ccveu-net'
    assert len(xml.get('qemuCaps')) == 3
    disks = xml.get_elements('./domain/devices/disk')
    assert len(disks) == 1
    assert disks[0].get('device', None) == 'cdrom'
    xml = qemu_xml.VarQemuXML(context_wrap(XML_IDM_CLIENT_NO_NAME, path='/var/run/libvirt/qemu/no_name.xml'))
    assert xml.vm_name is None
    return