# uncompyle6 version 3.7.4
# Python bytecode 3.5 (3350)
# Decompiled from: Python 3.6.9 (default, Apr 18 2020, 01:56:04) 
# [GCC 8.4.0]
# Embedded file name: /home/ggg/www/dev/mogos/mogo42/mogo/vvpages/management/commands/build_routes.py
# Compiled at: 2017-04-16 11:55:44
# Size of source mod 2**32: 1657 bytes
from __future__ import print_function
import os
from django.core.management.base import BaseCommand, CommandError
from django.conf import settings
from vvpages.models import Page
from django.core.urlresolvers import reverse

class Command(BaseCommand):
    help = 'Build routes for vvpages'

    def handle(self, *args, **options):
        pages = Page.objects.filter(published=True)
        print('Building routes ...')
        routes = []
        i = 1
        for page in pages:
            rest_url = reverse('vvpages-rest', kwargs={'pk': page.pk})
            val = "page('" + page.url + "', function(ctx, next) { app.loadHtml('" + rest_url + "') } );"
            routes.append(val)
            print(str(i) + ': ' + page.url)
            i += 1

        routes_str = '{# ************ Autogenerated file: do not edit ************ #}\n' + '\n'.join(routes)
        dirpath = settings.BASE_DIR + '/templates/vvpages'
        if os.path.isdir(dirpath) is not True:
            print('Creating directory templates/vvpages')
            os.makedirs(dirpath)
        dirpath = settings.BASE_DIR + '/templates/vvpages/auto'
        if os.path.isdir(dirpath) is not True:
            os.makedirs(dirpath)
            print('Creating directory templates/vvpages/auto')
        filepath = settings.BASE_DIR + '/templates/vvpages/auto/routes.js'
        print('Updating templates/vvpages/auto/routes.js')
        filex = open(filepath, 'w')
        filex.write(routes_str)
        filex.close()
        print('OK: ' + str(i - 1) + ' routes built ')